(("undefined"!==typeof self?self:this)["webpackJsonpnode_driver_1_0_0"]=("undefined"!==typeof self?self:this)["webpackJsonpnode_driver_1_0_0"]||[]).push([[1],{"0644":function(t,e,s){"use strict";s("f130")},"12f0":function(t,e,s){"use strict";s.r(e);var a=function(){var t=this,e=t._self._c;return e("div",[e("div",{staticClass:"row"},[e("div",{staticClass:"col span-6"},[e("LabeledInput",{attrs:{value:t.value.decodedData.endpoint,disabled:1!==t.step,"label-key":"driver.openstack.auth.fields.endpoint","placeholder-key":"driver.openstack.auth.placeholders.endpoint",type:"text",mode:t.mode},on:{input:function(e){return t.value.setData("endpoint",e)}}})],1),e("div",{staticClass:"col span-6"},[e("LabeledInput",{attrs:{value:t.value.decodedData.domainName,disabled:1!==t.step,"label-key":"driver.openstack.auth.fields.domainName","placeholder-key":"driver.openstack.auth.placeholders.domainName",type:"text",mode:t.mode},on:{input:function(e){return t.value.setData("domainName",e)}}})],1)]),e("div",{staticClass:"row"},[e("div",{staticClass:"col span-6"},[e("LabeledInput",{staticClass:"mt-20",attrs:{value:t.value.decodedData.username,disabled:1!==t.step,"label-key":"driver.openstack.auth.fields.username","placeholder-key":"driver.openstack.auth.placeholders.username",type:"text",mode:t.mode},on:{input:function(e){return t.value.setData("username",e)}}})],1),e("div",{staticClass:"col span-6"},[e("LabeledInput",{staticClass:"mt-20",attrs:{value:t.value.decodedData.password,disabled:1!==t.step,"label-key":"driver.openstack.auth.fields.password","placeholder-key":"driver.openstack.auth.placeholders.password",type:"password",mode:t.mode},on:{input:function(e){return t.value.setData("password",e)}}})],1)]),e("BusyButton",{ref:"connect",staticClass:"mt-20",attrs:{"label-key":"driver.openstack.auth.actions.authenticate",disabled:1!==t.step||!t.canAuthenticate},on:{click:t.connect}}),e("button",{staticClass:"btn role-primary mt-20 ml-20",attrs:{disabled:t.busy||1===t.step},on:{click:t.clear}},[t._v(" "+t._s(t.t("driver.openstack.auth.actions.edit"))+" ")]),t.error?e("Banner",{staticClass:"mt-20",attrs:{color:"error"}},[t._v(" "+t._s(t.error)+" ")]):t._e(),t.errorAllowHost?e("Banner",{staticClass:"allow-list-error",attrs:{color:"error"}},[e("div",[t._v(" "+t._s(t.t("driver.openstack.auth.errors.notAllowed",{hostname:t.hostname}))+" ")]),e("button",{staticClass:"btn ml-10 role-primary",attrs:{disabled:t.allowBusy},on:{click:t.addHostToAllowList}},[t._v(" "+t._s(t.t("driver.openstack.auth.actions.addToAllowList"))+" ")])]):t._e(),t.projects?e("div",{staticClass:"row mt-20"},[e("div",{staticClass:"col span-6"},[e("LabeledSelect",{attrs:{"label-key":"driver.openstack.auth.fields.project",options:t.projectOptions,searchable:!1},model:{value:t.project,callback:function(e){t.project=e},expression:"project"}})],1),t.regions?e("div",{staticClass:"col span-6"},[e("LabeledSelect",{attrs:{"label-key":"driver.openstack.auth.fields.region",options:t.regionOptions,searchable:!1},model:{value:t.region,callback:function(e){t.region=e},expression:"region"}})],1):t._e()]):t._e()],1)},o=[],i=s("eb32"),n=s("8e93"),r=s("466b");function l(t){const e=l.options,s=e.parser[e.strictMode?"strict":"loose"].exec(t);if(!s)throw new Error("Cannot parse as uri: "+t);const a={};let o=14;while(o--)a[e.key[o]]=s[o]||"";return a.query={},a.queryStr.replace(e.q.parser,(t,s,o)=>(s&&(a[e.q.name][s]=o),"")),a}l.options={strictMode:!1,key:["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","queryStr","anchor"],q:{name:"query",parser:/(?:^|&)([^&=]*)=?([^&]*)/g},parser:{strict:/^(?:([^:\/?#]+):)?(?:\/\/((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?))?((((?:[^?#\/]*\/)*)([^?#]*))(?:\?([^#]*))?(?:#(.*))?)/,loose:/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/}};var d=s("da25"),c=function(){var t=this,e=t._self._c;t._self._setupProxy;return e("button",{ref:"btn",staticClass:"btn role-primary",attrs:{disabled:t.disabled,"tab-index":t.tabIndex,"data-testid":t.componentTestid+"-async-button"},on:{click:t.clicked}},[t.busy?e("i",{staticClass:"icon icon-lg icon-spinner icon-spin"}):e("span",{staticClass:"icon-spacer"}),e("span",[t._v(t._s(t.displayLabel))]),e("span",{staticClass:"icon-spacer"})])},u=[],p=s("8bbf"),h=s.n(p),m=h.a.extend({props:{label:{type:String,default:void 0},labelKey:{type:String,default:void 0},disabled:{type:Boolean,default:!1},tabIndex:{type:Number,default:null},componentTestid:{type:String,default:"busy-button"},manual:{type:Boolean,default:!1}},data(){return{busy:!1}},computed:{displayLabel(){if(this.labelKey){const t=this.$store.getters["i18n/t"];return t(this.labelKey)}return this.label}},methods:{clicked(t){if(t&&(t.stopPropagation(),t.preventDefault()),this.disabled)return;const e=()=>{this.busy=!1};this.$set(this,"busy",!0),this.$emit("click",e)},focus(){this.$refs.btn.focus()}}}),v=m,y=(s("526c"),s("d802")),f=Object(y["a"])(v,c,u,!1,null,"7ff90ee0",null),g=f.exports,b=s("f2d8"),k={components:{Banner:i["a"],BusyButton:g,LabeledInput:n["a"],LabeledSelect:r["a"]},props:{mode:{type:String,required:!0},value:{type:Object,required:!0}},async fetch(){this.driver=await this.$store.dispatch("rancher/find",{type:"nodedriver",id:"openstack"})},data(){return this.mode!==d["a"]&&(this.value.decodedData.username=this.value.annotations["openstack.cattle.io/username"],this.value.decodedData.domainName=this.value.annotations["openstack.cattle.io/domainName"],this.value.decodedData.endpoint=this.value.annotations["openstack.cattle.io/endpoint"]),{projects:null,regions:null,step:1,busy:!1,project:"",region:"",errorAllowHost:!1,driver:{},allowBusy:!1,error:""}},computed:{projectOptions(){const t=(this.projects||[]).sort((t,e)=>t.name.localeCompare(e.name));return t.map(t=>({label:t.name,value:t.id}))},regionOptions(){const t=(this.regions||[]).sort((t,e)=>t.name.localeCompare(e.name));return t.map(t=>({label:t.id,value:t.id}))},hostname(){const t=l(this.value.decodedData.endpoint);return(null===t||void 0===t?void 0:t.host)||""},canAuthenticate(){var t,e,s,a;return!(null===(t=this.value)||void 0===t||null===(t=t.decodedData)||void 0===t||!t.endpoint)&&!(null===(e=this.value)||void 0===e||null===(e=e.decodedData)||void 0===e||!e.domainName)&&!(null===(s=this.value)||void 0===s||null===(s=s.decodedData)||void 0===s||!s.username)&&!(null===(a=this.value)||void 0===a||null===(a=a.decodedData)||void 0===a||!a.password)}},created(){this.$emit("validationChanged",!1)},methods:{test(){this.value.annotations=this.value.annotations||{},this.value.annotations["openstack.cattle.io/username"]=this.value.decodedData.username,this.value.annotations["openstack.cattle.io/domainName"]=this.value.decodedData.domainName,this.value.annotations["openstack.cattle.io/endpoint"]=this.value.decodedData.endpoint;const t=this.projects.find(t=>t.id===this.project);return t&&(this.value.annotations["openstack.cattle.io/projectName"]=t.name,this.value.annotations["openstack.cattle.io/projectId"]=t.id,this.value.annotations["openstack.cattle.io/projectDomainName"]=t.domain_id),this.region&&(this.value.annotations["openstack.cattle.io/region"]=this.region),!0},clear(){this.$set(this,"step",1),this.$set(this,"projects",null),this.$set(this,"errorAllowHost",!1),this.$emit("validationChanged",!1)},hostInAllowList(){var t,e;if(null===(t=this.driver)||void 0===t||!t.whitelistDomains)return!1;const s=l(this.value.decodedData.endpoint);return!s.host||((null===(e=this.driver)||void 0===e?void 0:e.whitelistDomains)||[]).includes(s.host)},async addHostToAllowList(){this.$set(this,"allowBusy",!0);const t=l(this.value.decodedData.endpoint);this.driver.whitelistDomains=this.driver.whitelistDomains||[],this.hostInAllowList()||this.driver.whitelistDomains.push(t.host);try{await this.driver.save(),this.$refs.connect.$el.click()}catch(e){console.error("Could not update driver",e),this.$set(this,"allowBusy",!1)}},async connect(t){var e,s;this.$set(this,"error",""),this.$set(this,"errorAllowHost",!1);let a=!1;if(!this.value.decodedData.endpoint)return t(a);const o=new b["a"](this.$store,{endpoint:this.value.decodedData.endpoint,domainName:this.value.decodedData.domainName,username:this.value.decodedData.username,password:this.value.decodedData.password});this.$set(this,"allowBusy",!1),this.$set(this,"step",2),this.$set(this,"busy",!0);const i=await o.getToken();if(i.error)console.error(i.error),a=!1,this.$set(this,"step",1),this.$set(this,"projects",null),502!==i.error._status||this.hostInAllowList()?502===i.error._status?this.$set(this,"error",this.t("driver.openstack.auth.errors.badGateway")):401===i.error._status?this.$set(this,"error",this.t("driver.openstack.auth.errors.unauthorized")):this.$set(this,"error",i.error.message||this.t("driver.openstack.auth.errors.other")):this.$set(this,"errorAllowHost",!0);else{const t=await o.getProjects();t.error?this.$set(this,"error",t.error.message):(this.$set(this,"projects",t),a=!0);const e=await o.getRegions();if(e.error){const t=this.projectOptions[0].value,e=this.projects.find(e=>e.id===t);if(e){const t=new b["a"](this.$store,{...o,projectName:e.name,projectId:e.id,projectDomainName:e.domain_id});await t.getToken().then(()=>{this.$set(this,"regions",t.regionsFromCatalog)})}}else this.$set(this,"regions",e),a=!0}this.$set(this,"busy",!1),this.$set(this,"project",null===(e=this.projectOptions[0])||void 0===e?void 0:e.value),this.$set(this,"region",null===(s=this.regionOptions[0])||void 0===s?void 0:s.value),this.$emit("validationChanged",a),t(a)}}},w=k,j=(s("0644"),Object(y["a"])(w,a,o,!1,null,"5b86ab48",null));e["default"]=j.exports},2760:function(t,e,s){var a=s("5eaa");e=a(!1),e.push([t.i,".icon-spacer[data-v-7ff90ee0]{width:24px}",""]),t.exports=e},"526c":function(t,e,s){"use strict";s("a0d7")},a0d7:function(t,e,s){var a=s("2760");a.__esModule&&(a=a.default),"string"===typeof a&&(a=[[t.i,a,""]]),a.locals&&(t.exports=a.locals);var o=s("0ed3").default;o("32d435e8",a,!0,{sourceMap:!1,shadowMode:!1})},f130:function(t,e,s){var a=s("f993");a.__esModule&&(a=a.default),"string"===typeof a&&(a=[[t.i,a,""]]),a.locals&&(t.exports=a.locals);var o=s("0ed3").default;o("0c3a7ed2",a,!0,{sourceMap:!1,shadowMode:!1})},f2d8:function(t,e,s){"use strict";s.d(e,"a",(function(){return a}));class a{constructor(t,e){this.domainName="",this.endpoint="",this.projectDomainName="",this.projectId="",this.projectName="",this.username="",this.password="",this.token="",this.region="",this.userId="",this.regionsFromCatalog=[],e.annotations?Object.keys(e.annotations).forEach(t=>{const s=t.split("/");if(2===s.length&&"openstack.cattle.io"===s[0]){const a=s[1];this[a]=e.annotations[t]}}):Object.keys(e).forEach(t=>{this[t]=e[t]}),this.$dispatch=t.dispatch}async getToken(){const t=this.endpoint.replace(/^https?:\/\//,""),e="/meta/proxy/"+t,s=e+"/auth/tokens",a={auth:{identity:{methods:["password"],password:{user:{name:this.username,domain:{name:this.domainName},password:this.password}}}}};this.projectName&&(a.auth.scope={project:{name:this.projectName,domain:{name:this.projectDomainName}}});const o={Accept:"application/json"};try{var i;const t=await this.$dispatch("management/request",{url:s,headers:o,method:"POST",redirectUnauthorized:!1,data:a},{root:!0});if(502===t._status)return{error:"Could not proxy request - URL may not be in Rancher's allow list"};const e=t._headers["x-subject-token"];return this.token=e,this.userId=null===t||void 0===t||null===(i=t.token)||void 0===i||null===(i=i.user)||void 0===i?void 0:i.id,this.regionsFromCatalog=[],a.auth.scope&&null!==t&&void 0!==t&&t.token&&(this.catalog=t.token.catalog,this.endpoints={},this.catalog.forEach(t=>{const e=t.endpoints.find(t=>"public"===t.interface);e&&e.region_id===this.region&&(this.endpoints[t.type]=e.url),e&&"compute"===t.type&&(this.regionsFromCatalog.includes(e.region_id)||this.regionsFromCatalog.push(e.region_id))})),this.regionsFromCatalog=this.regionsFromCatalog.map(t=>({id:t})),t}catch(n){return console.error(n),{error:n}}}async getFlavors(t,e){return await this.getOptions(t,"/flavors","flavors",void 0,e)}async getImages(t,e){return await this.getOptions(t,"/images/detail","images",void 0,e)}async getKeyPairs(t,e){return await this.getOptions(t,"/os-keypairs","keypairs",t=>t.keypair,e)}async getSecurityGroups(t,e){return await this.getOptions(t,"/os-security-groups","security_groups",void 0,e)}async getFloatingIpPools(t,e){return await this.getOptions(t,"/os-floating-ip-pools","floating_ip_pools",void 0,e)}async getNetworkNames(t,e){return await this.getOptions(t,"/os-tenant-networks","networks",t=>({...t,name:t.label}),e)}async getAvailabilityZones(t,e){return await this.getOptions(t,"/os-availability-zone","availabilityZoneInfo",t=>({...t,name:t.zoneName}),e)}async getOptions(t,e,s,a,o){t.busy=!0,t.enabled=!0,t.selected="";const i=await this.makeComputeRequest(e);if(i&&i[s]){let e=i[s]||[];if(a&&(e=e.map(t=>a(t))),t.options=this.convertToOptions(e),t.busy=!1,o){const e=t.options.find(t=>t.value.name===o);e&&(t.selected=e.value)}!t.selected&&t.options.length>0&&(t.selected=t.options[0].value)}else t.options=[],t.selected=null,t.busy=!1,t.enabled=!1}async makeComputeRequest(t){const e=this.endpoints["compute"].replace(/^https?:\/\//,""),s="/meta/proxy/"+e,a=`${s}${t}`,o={Accept:"application/json","X-Auth-Token":this.token};try{const t=await this.$dispatch("management/request",{url:a,headers:o,method:"GET",redirectUnauthorized:!1},{root:!0});return t}catch(i){console.error(i)}}async getProjects(){const t=this.endpoint.replace(/^https?:\/\//,""),e="/meta/proxy/"+t,s={Accept:"application/json","X-Auth-Token":this.token};try{const t=await this.$dispatch("management/request",{url:`${e}/users/${this.userId}/projects`,headers:s,method:"GET",redirectUnauthorized:!1},{root:!0});return null===t||void 0===t?void 0:t.projects}catch(a){return console.error(a),{error:a}}}async getRegions(){const t=this.endpoint.replace(/^https?:\/\//,""),e="/meta/proxy/"+t,s={Accept:"application/json","X-Auth-Token":this.token};try{const t=await this.$dispatch("management/request",{url:e+"/regions",headers:s,method:"GET",redirectUnauthorized:!1},{root:!0});return null===t||void 0===t?void 0:t.regions}catch(a){return console.error(a),{error:a}}}convertToOptions(t){const e=(t||[]).sort((t,e)=>t.name.localeCompare(e.name));return e.map(t=>({label:t.name,value:t}))}}},f993:function(t,e,s){var a=s("5eaa");e=a(!1),e.push([t.i,".allow-list-error[data-v-5b86ab48]{display:flex}.allow-list-error[data-v-5b86ab48]>:first-child{flex:1}",""]),t.exports=e}}]);
//# sourceMappingURL=node-driver-1.0.0.umd.min.cloud-credential.js.map